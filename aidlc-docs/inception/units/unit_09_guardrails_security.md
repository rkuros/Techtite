# Unit 9: ガードレール・セキュリティ

> **対応 Epic**: Epic 6 — AIエージェント管理・ターミナル（ガードレール部分）
> **対応ストーリー**: US-6.13〜US-6.16

---

## ユーザーストーリーと受け入れ基準

### US-6.13 [Should] APIコスト・トークン使用量管理

個人開発者として、AIエージェントのAPIコスト（トークン使用量）をダッシュボードで確認し、上限設定で意図しない高額請求を防ぎたい。なぜなら、複数エージェント並列稼働+RAG+アンビエントエージェントでトークン消費が大きくなるからだ。

- [ ] ダッシュボードにエージェント別・合計のトークン使用量と推定コストが表示される
- [ ] 日次/月次のコスト推移グラフが表示される
- [ ] コスト上限（日次/月次）を設定でき、上限到達時にエージェントが自動停止する
- [ ] 上限接近時に警告通知が表示される（例: 80%到達時）
- [ ] エージェント種別ごと（作業エージェント/アンビエント/RAG）のコスト内訳が確認できる

### US-6.14 [Should] ログローテーション・肥大化対策

個人開発者として、システムレベルの操作ログ（US-6.10）が肥大化しないよう、自動ローテーション・圧縮してほしい。なぜなら、全操作を常時キャプチャし続けるとストレージが逼迫するからだ。

- [ ] ログの保持期間を設定できる（デフォルト: 30日）
- [ ] 保持期間を過ぎた生ログが自動圧縮（gzip等）される
- [ ] 圧縮後一定期間経過した生ログが自動パージされる（構造化セッションログは保持）
- [ ] ビルド出力等の大容量ログに対するフィルタリングルールを設定できる
- [ ] 現在のログストレージ使用量がダッシュボードに表示される

### US-6.15 [Should] エージェント実行環境サンドボックス

個人開発者として、AIエージェントのターミナル実行環境がサンドボックス化されてほしい。なぜなら、エージェントが意図せず破壊的なコマンドや機密情報へのアクセスを行うリスクを防ぎたいからだ。

- [ ] エージェント用ターミナルがプロジェクトディレクトリ（Vault）をルートとした制限された環境で動作する
- [ ] 許可/禁止するコマンドのホワイトリスト/ブラックリストを設定できる
- [ ] Vault外のファイルシステム（`~/.ssh`、`/etc`等）へのアクセスが制限される
- [ ] 破壊的コマンド（`rm -rf /`等）がブロックされ、実行前に確認が求められる
- [ ] （拡張）Dockerコンテナ等の隔離環境でのエージェント実行オプション

### US-6.16 [Should] 認証情報の安全な保管

個人開発者として、外部サービスの認証情報（API Key、Token等）が安全に保管されてほしい。なぜなら、Zenn/Note/X/Threads/GitHub/OpenAI等の認証情報が漏洩するリスクを防ぎたいからだ。

- [ ] 認証情報がOS標準のキーチェーン/資格情報マネージャーに暗号化保存される
- [ ] 認証情報がプロジェクトファイルやGitリポジトリに含まれない
- [ ] 認証情報の一覧管理画面で追加・更新・削除ができる
- [ ] エージェントからの認証情報アクセスは必要最小限のスコープに制限される
