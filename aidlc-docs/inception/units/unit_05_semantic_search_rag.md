# Unit 5: セマンティック検索・RAG

> **対応 Epic**: Epic 4 — ナレッジベース機能（RAG部分）
> **対応ストーリー**: US-4.12〜US-4.19

---

## ユーザーストーリーと受け入れ基準

### US-4.12 [Should] ベクトルインデックス自動構築（ローカル）

個人開発者として、Vault内のドキュメントが自動的にベクトルインデックス化されてほしい。なぜなら、手動でインデックスを管理せず、常に最新の状態でセマンティック検索を利用したいからだ。

- [ ] .gitignore適用後のVault内ファイル（Git同期対象と同一スコープ）がローカルEmbeddingモデル（ONNX Runtime等）で自動ベクトル化される
- [ ] ファイルの作成・編集・削除時にインデックスが差分更新される
- [ ] マークダウンの構造（見出し・セクション単位）を考慮したチャンキングが行われる
- [ ] インデックス構築はバックグラウンドで実行され、UIをブロックしない
- [ ] 設定でRAG機能のオン/オフを切り替えられる（デフォルト: オン）
- [ ] ローカルVector Store（sqlite-vss等）にインデックスが保存される
- [ ] ベクトルインデックスは各端末で独自に生成される（Git同期対象外。ソースドキュメントから再生成可能な派生データとして扱う）
- [ ] 新しい端末でVaultを開いた際、バックグラウンドでインデックスが自動構築される
- [ ] バックグラウンドインデックス構築のCPU/メモリ使用量に上限が設定される（デフォルト: 論理コア数の75%以下、メモリ2GB以下。設定で調整可能）
- [ ] インデックス構築キューの同時処理数が制限される（デフォルト: 同時4ファイルまで。設定で調整可能）
- [ ] （拡張）中央集約型Vector DBが必要な場合はクラウドデプロイオプションとして提供（US-4.17）

### US-4.13 [Should] セマンティック検索（自然言語クエリ）

個人開発者として、自然言語で質問してセマンティック検索したい。なぜなら、正確なキーワードを覚えていなくても、意味的に関連するドキュメントを見つけたいからだ。

- [ ] 検索パネルでキーワード検索とセマンティック検索を切り替え（または併用）できる
- [ ] 自然言語の質問文（例:「認証周りの設計判断」）で関連ドキュメントが検索される
- [ ] 検索結果に類似度スコアと該当セクションのプレビューが表示される
- [ ] 検索結果をクリックすると該当ファイルの該当箇所に遷移する

### US-4.14 [Should] AIエージェントRAGコンテキスト取得

AIエージェントとして、セマンティック検索を利用してタスクに関連するドキュメント・コードのコンテキストを取得したい。なぜなら、プロジェクト全体のナレッジから最も関連性の高い情報をもとに、質の高いコード・ドキュメントを生成したいからだ。

- [ ] API経由で自然言語クエリによるセマンティック検索が実行できる
- [ ] 検索結果にファイルパス、該当セクション、類似度スコアが含まれる
- [ ] 取得する結果件数（top-k）を指定できる
- [ ] キーワード検索とセマンティック検索を組み合わせたハイブリッド検索が実行できる

### US-4.15 [Could] クロスプロジェクト（Vault横断）検索

個人開発者として、複数のプロジェクト（Vault）を横断してセマンティック検索したい。なぜなら、過去のプロジェクトの知見を現在のプロジェクトに活用したいからだ。

- [ ] 検索対象に他のVault（プロジェクト）を追加できる
- [ ] 検索結果にVault名（プロジェクト名）が表示される
- [ ] 検索対象Vaultのフィルタリング（含める/除外する）ができる

### US-4.16 [Should] ナレッジ検索AIチャット

個人開発者として、ナレッジベースに対してチャット形式で質問したい。なぜなら、検索キーワードを考えるのではなく、会話的にプロジェクトの情報を引き出したいからだ。

- [ ] ナレッジ検索専用のAIチャットパネルが開ける
- [ ] チャットの質問に対し、ローカルのベクトルインデックスから関連ドキュメントを検索（RAG）した上でAIが回答する
- [ ] 回答に参照元ドキュメントへのリンクが含まれる
- [ ] 会話の文脈を保持して連続的に質問できる

### US-4.17 [Could] 外部Embedding/Vector DB連携（拡張）

個人開発者として、Embeddingモデルやベクトルデータベースを外部サービスに切り替えたい。なぜなら、より高品質なモデルや大規模なベクトルDBを利用したいケースがあるからだ。

- [ ] 設定画面でEmbeddingモデルを切り替えられる（ローカル/外部API）
- [ ] 外部Embedding API（OpenAI等）のエンドポイント・認証情報を設定できる
- [ ] 外部Vector DB（Qdrant, Pinecone等）への接続設定ができる
- [ ] ローカルモードと外部モードをプロジェクト単位で切り替えられる

### US-4.18 [Could] RAG品質自動モニタリング・自動最適化

個人開発者として、RAGの検索精度が自動的にモニタリングされ、精度低下時にパラメータ調整とインデックス再構築が自動実行されてほしい。なぜなら、RAGの品質管理を手動で行う専門知識がなくても、常に高品質な検索結果を得たいからだ。

- [ ] バックグラウンドエージェントがサンプルクエリで検索品質スコアを定期的に自動測定する
- [ ] インデックスのヘルス指標（カバレッジ率、鮮度、断片化率）がダッシュボードで確認できる
- [ ] 品質スコアが閾値を下回った場合、パラメータ（チャンクサイズ、オーバーラップ率、ハイブリッド検索重み等）の自動チューニングが実行される
- [ ] チューニング後にインデックスの自動再構築がバックグラウンドで実行される
- [ ] 再構築前後の品質スコア比較が記録され、改善を確認できる
- [ ] リランキング（Cross-Encoderによる検索結果の精密再順位付け）が自動適用される

### US-4.19 [Won't] 検索フィードバック自動学習ループ

個人開発者として、日常の検索行動から暗黙的にフィードバックが収集され、検索精度が継続的に改善されてほしい。なぜなら、明示的な評価操作をしなくても、使えば使うほど検索が賢くなってほしいからだ。

- [ ] 検索結果のクリック位置・スキップパターンが暗黙フィードバックとして収集される
- [ ] AIチャット（US-4.16）での質問と参照ドキュメントの関連性がフィードバックとして記録される
- [ ] 収集されたフィードバックがRAG品質スコアの算出に反映される
- [ ] フィードバックデータはローカルに保存され、外部に送信されない（プライバシー保護）
